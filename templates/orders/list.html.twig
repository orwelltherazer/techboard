{# templates/orders/list.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}TechBoard - Commandes{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Gestion des commandes</h2>
    <div>
        <a href="orders.php?action=add" class="btn btn-primary">Nouvelle commande</a>
        {% if show_archived %}
        <a href="orders.php" class="btn btn-outline-secondary ms-1">Commandes actives</a>
        {% else %}
        <a href="orders.php?archived=1" class="btn btn-outline-secondary ms-1">Archivées</a>
        {% endif %}
    </div>
</div>

{% if success %}
<div class="alert alert-success alert-dismissible fade show" role="alert" id="success-alert">
    {{ success }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<script>
    setTimeout(function() {
        var alert = document.getElementById('success-alert');
        if (alert) {
            alert.classList.remove('show');
            setTimeout(function() {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 150);
        }
    }, 3000);
</script>
{% endif %}

<div class="row mb-3">
    <div class="col-md-3">
        <select class="form-select" id="filter-status">
            <option value="">Tous les statuts</option>
            <option value="ordered">Commandée</option>
            <option value="received">Reçue</option>
            <option value="invoiced">Facturée</option>
            <option value="cancelled">Annulée</option>
        </select>
    </div>
    <div class="col-md-3">
        <input type="text" class="form-control" id="search-orders" placeholder="Rechercher...">
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th scope="col">Référence</th>
                <th scope="col">Fournisseur</th>
                <th scope="col">Montant</th>
                <th scope="col">Statut</th>
                <th scope="col">Date</th>
                <th scope="col" class="text-center" style="width: 1px;"></th>
            </tr>
        </thead>
        <tbody id="orders-table-body">
            {% for order in orders %}
            <tr class="order-row clickable-row"
                data-status="{{ order.status }}"
                data-reference="{{ order.reference|lower }}"
                data-vendor="{{ order.vendor_name|lower|default('') }}"
                data-project="{{ order.project_name|lower|default('') }}">
                <td>
                    <div>
                        <strong>{{ order.reference }}</strong>
                        {% if order.description %}
                            <div class="text-muted small mt-1">{{ order.description|length > 80 ? order.description|slice(0, 80) ~ '...' : order.description }}</div>
                        {% endif %}
                    </div>
                    <div class="order-details mt-2 d-none">
                        <div class="row small">
                            <div class="col-md-4"><strong>Projet :</strong> {{ order.project_name|default('—') }}</div>
                            <div class="col-md-4"><strong>Fournisseur :</strong> {{ order.vendor_name|default('—') }}</div>
                            <div class="col-md-4"><strong>Société :</strong> {{ order.vendor_company|default('—') }}</div>
                        </div>
                    </div>
                </td>
                <td>{{ order.vendor_name|default('—') }}</td>
                <td>
                    {% if order.amount %}
                        {{ order.amount|number_format(2, ',', ' ') }} €
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td>
                    <span class="badge fw-bold
                        {% if order.status == 'ordered' %}bg-info
                        {% elseif order.status == 'received' %}bg-success
                        {% elseif order.status == 'invoiced' %}bg-primary
                        {% else %}bg-secondary{% endif %}">
                        {% if order.status == 'ordered' %}Commandée
                        {% elseif order.status == 'received' %}Reçue
                        {% elseif order.status == 'invoiced' %}Facturée
                        {% else %}Annulée{% endif %}
                    </span>
                </td>
                <td class="text-center align-middle">
                    {% if order.order_date %}
                        {{ order.order_date|date('d/m/Y') }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td class="text-center align-middle">
                    <a href="orders.php?action=edit&id={{ order.id }}" class="btn btn-sm btn-outline-primary border-0">
                        <i class="fas fa-edit"></i>
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center text-muted">
                    {% if show_archived %}
                        Aucune commande archivée
                    {% else %}
                        Aucune commande trouvée
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Toggle détails commande au clic sur la ligne
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', function (e) {
            // Ne pas déplier si on clique sur un bouton
            if (e.target.closest('.btn')) {
                return;
            }

            const details = this.querySelector('.order-details');
            details.classList.toggle('d-none');
        });
    });

    // Filtrage
    const statusFilter = document.getElementById('filter-status');
    const searchInput = document.getElementById('search-orders');
    const orderRows = document.querySelectorAll('.order-row');

    function filterOrders() {
        const statusValue = statusFilter.value;
        const searchValue = searchInput.value.toLowerCase();

        orderRows.forEach(row => {
            const statusMatch = !statusValue || row.dataset.status === statusValue;
            const searchMatch = !searchValue ||
                row.dataset.reference.includes(searchValue) ||
                row.dataset.vendor.includes(searchValue) ||
                row.dataset.project.includes(searchValue);

            row.style.display = (statusMatch && searchMatch) ? '' : 'none';
        });
    }

    statusFilter.addEventListener('change', filterOrders);
    searchInput.addEventListener('input', filterOrders);
});
</script>
{% endblock %}
