{# templates/admin/contracts_list.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}TechBoard - Contrats{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Contrats</h2>
    <a href="administration.php?action=contract_add" class="btn btn-primary">Nouveau contrat</a>
</div>

{% if success %}
<div class="alert alert-success alert-dismissible fade show" role="alert" id="success-alert">
    {{ success }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<script>
    setTimeout(function() {
        var alert = document.getElementById('success-alert');
        if (alert) {
            alert.classList.remove('show');
            setTimeout(function() {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 150);
        }
    }, 3000);
</script>
{% endif %}

<div class="row mb-3">
    <div class="col-md-3">
        <select class="form-select" id="filter-type">
            <option value="">Tous les types</option>
            <option value="maintenance">Maintenance</option>
            <option value="licence">Licence</option>
            <option value="hebergement">Hébergement</option>
            <option value="service">Service</option>
        </select>
    </div>
    <div class="col-md-3">
        <input type="text" class="form-control" id="search-contracts" placeholder="Rechercher...">
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th scope="col">Nom</th>
                <th scope="col">Fournisseur</th>
                <th scope="col">Type</th>
                <th scope="col">Début / Fin</th>
                <th scope="col">Montant annuel</th>
                <th scope="col">Renouvellement</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody id="contracts-table-body">
            {% for contract in contracts %}
            <tr class="contract-row" 
                data-type="{{ contract.contract_type }}" 
                data-name="{{ contract.name|lower }}"
                data-vendor="{{ contract.vendor_name|lower|default('') }}"
                data-id="contract-{{ contract.id }}">
                <td>
                    <strong>{{ contract.name }}</strong>
                    <div class="contract-details d-none mt-2 p-2 bg-light rounded" id="details-{{ contract.id }}">
                        <div><strong>Description :</strong> {{ contract.notes|default('—') }}</div>
                        <div><strong>Fournisseur :</strong> {{ contract.vendor_name }}</div>
                    </div>
                </td>
                <td>{{ contract.vendor_name }}</td>
                <td>{{ contract.contract_type|default('—') }}</td>
                <td>
                    {{ contract.start_date ? contract.start_date|date('d/m/Y') : '—' }} 
                    / 
                    {{ contract.end_date ? contract.end_date|date('d/m/Y') : '—' }}
                </td>
                <td>{{ contract.annual_amount ? contract.annual_amount|number_format(2, ',', ' ') ~ ' €' : '—' }}</td>
                <td>
                    {% if contract.auto_renew %}
                        <span class="badge bg-success">Automatique</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">Manuel</span>
                    {% endif %}
                </td>
                <td>
                    <a href="administration.php?action=contract_edit&id={{ contract.id }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-edit"></i>
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center text-muted">Aucun contrat trouvé</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const typeFilter = document.getElementById('filter-type');
    const searchInput = document.getElementById('search-contracts');
    const contractRows = document.querySelectorAll('.contract-row');
    let currentlyExpanded = null;
    
    contractRows.forEach(row => {
        const cell = row.querySelector('td:first-child');
        const details = row.querySelector('.contract-details');
        const contractId = row.dataset.id;
        
        cell.style.cursor = 'pointer';
        
        cell.addEventListener('click', function(e) {
            if (e.target.tagName === 'A') return;
            
            if (currentlyExpanded && currentlyExpanded !== contractId) {
                document.getElementById('details-' + currentlyExpanded.split('-')[1]).classList.add('d-none');
            }
            
            if (details.classList.contains('d-none')) {
                details.classList.remove('d-none');
                currentlyExpanded = contractId;
            } else {
                details.classList.add('d-none');
                currentlyExpanded = null;
            }
        });
    });
    
    function filterContracts() {
        const typeValue = typeFilter.value;
        const searchValue = searchInput.value.toLowerCase();
        
        contractRows.forEach(row => {
            const typeMatch = !typeValue || row.dataset.type === typeValue;
            const searchMatch = !searchValue || 
                row.dataset.name.includes(searchValue) || 
                row.dataset.vendor.includes(searchValue);
            
            row.style.display = (typeMatch && searchMatch) ? '' : 'none';
            
            if (!typeMatch || !searchMatch) {
                const details = row.querySelector('.contract-details');
                if (details && !details.classList.contains('d-none')) {
                    details.classList.add('d-none');
                    if (currentlyExpanded === row.dataset.id) {
                        currentlyExpanded = null;
                    }
                }
            }
        });
    }
    
    typeFilter.addEventListener('change', filterContracts);
    searchInput.addEventListener('input', filterContracts);
});
</script>
{% endblock %}