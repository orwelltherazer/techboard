{# templates/projects/form.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}TechBoard - {{ is_edit ? 'Modifier' : 'Nouveau' }} projet{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 mb-0">{{ is_edit ? 'Modifier le projet' : 'Nouveau projet' }}</h2>
    <a href="{% if is_edit %}projects.php?action=view&id={{ project.id }}{% else %}projects.php{% endif %}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Retour
    </a>
</div>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<div class="card border-0 shadow-sm" style="background-color: #fafafa;">
    <div class="card-body p-3">
        <form method="POST">
            <div class="row g-2">
                <div class="col-md-12">
                    <label for="name" class="form-label small fw-bold">Nom du projet *</label>
                    <input type="text" class="form-control form-control-sm" id="name" name="name" value="{{ project.name ?? '' }}" required>
                </div>
                
                <div class="col-md-12">
                    <label for="objective" class="form-label small fw-bold">Objectif</label>
                    <textarea class="form-control form-control-sm" id="objective" name="objective" rows="2">{{ project.objective ?? '' }}</textarea>
                </div>
                
                <div class="col-md-12">
                    <label for="context" class="form-label small fw-bold">Contexte / Justification</label>
                    <textarea class="form-control form-control-sm" id="context" name="context" rows="2">{{ project.context ?? '' }}</textarea>
                </div>
                
                <div class="col-md-6">
                    <label for="progress_percent" class="form-label small fw-bold">Avancement (%)</label>
                    <input type="number" class="form-control form-control-sm" id="progress_percent" name="progress_percent" min="0" max="100" value="{{ project.progress_percent ?? '0' }}">
                </div>
                
                <div class="col-md-6">
                    <label for="manager_id" class="form-label small fw-bold">Responsable</label>
                    <select class="form-select form-select-sm" id="manager_id" name="manager_id">
                        <option value="">Non assigné</option>
                        {% for contact in contacts %}
                        <option value="{{ contact.id }}" {% if contact.id == (project.manager_id ?? null) %}selected{% endif %}>
                            {{ contact.name }}{% if contact.company %} ({{ contact.company }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label for="start_date" class="form-label small fw-bold">Date de début</label>
                    <input type="date" class="form-control form-control-sm" id="start_date" name="start_date" value="{{ project.start_date ?? '' }}">
                </div>
                
                <div class="col-md-6">
                    <label for="estimated_end_date" class="form-label small fw-bold">Date de fin estimée</label>
                    <input type="date" class="form-control form-control-sm" id="estimated_end_date" name="estimated_end_date" value="{{ project.estimated_end_date ?? '' }}">
                </div>
                
                <div class="col-md-12">
                    <label for="internal_notes" class="form-label small fw-bold">Notes internes</label>
                    <textarea class="form-control form-control-sm" id="internal_notes" name="internal_notes" rows="2">{{ project.internal_notes ?? '' }}</textarea>
                </div>
            </div>
            
            <div class="mt-3 pt-2 border-top border-light d-flex justify-content-between">
                <div>
                    {% if is_edit %}
                        {% if project.archived %}
                            <button type="button" class="btn btn-sm btn-outline-success" id="unarchive-btn">
                                <i class="fas fa-undo"></i> Désarchiver
                            </button>
                        {% else %}
                            <button type="button" class="btn btn-sm btn-outline-warning" id="archive-btn">
                                <i class="fas fa-archive"></i> Archiver
                            </button>
                        {% endif %}
                        <button type="button" class="btn btn-sm btn-outline-danger ms-1" id="delete-btn">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    {% endif %}
                </div>
                <div>
                    <a href="{% if is_edit %}projects.php?action=view&id={{ project.id }}{% else %}projects.php{% endif %}" class="btn btn-sm btn-outline-secondary">Annuler</a>
                    <button type="submit" class="btn btn-success btn-sm px-3 ms-1">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if is_edit %}
    // Bouton Archiver
    const archiveBtn = document.getElementById('archive-btn');
    if (archiveBtn) {
        archiveBtn.addEventListener('click', function() {
            if (!confirm('Êtes-vous sûr de vouloir archiver ce projet ?')) {
                return;
            }

            fetch('projects.php?action=archive&id={{ project.id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = 'projects.php?success=archived';
                } else {
                    alert('Erreur lors de l\'archivage');
                }
            })
            .catch(error => {
                alert('Erreur de connexion');
            });
        });
    }

    // Bouton Désarchiver
    const unarchiveBtn = document.getElementById('unarchive-btn');
    if (unarchiveBtn) {
        unarchiveBtn.addEventListener('click', function() {
            if (!confirm('Êtes-vous sûr de vouloir désarchiver ce projet ?')) {
                return;
            }

            fetch('projects.php?action=unarchive&id={{ project.id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = 'projects.php?success=unarchived';
                } else {
                    alert('Erreur lors du désarchivage');
                }
            })
            .catch(error => {
                alert('Erreur de connexion');
            });
        });
    }

    // Bouton Supprimer
    const deleteBtn = document.getElementById('delete-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (!confirm('Êtes-vous sûr de vouloir supprimer définitivement ce projet ?\n\nCette action est irréversible.')) {
                return;
            }

            fetch('projects.php?action=delete&id={{ project.id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = 'projects.php?success=deleted';
                } else {
                    alert('Erreur lors de la suppression');
                }
            })
            .catch(error => {
                alert('Erreur de connexion');
            });
        });
    }
    {% endif %}
});
</script>
{% endblock %}